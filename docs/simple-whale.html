<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.13">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>2&nbsp; Simple whale – Optimizing Shiny apps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./summary.html" rel="next">
<link href="./intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-8d568fb58c33a0b3232b1f9968c626e4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ad3bc39150c09e3b1779ab6778d8ba3c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./simple-whale.html">Part 1: The CRAN whales app</a></li><li class="breadcrumb-item"><a href="./simple-whale.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Simple whale</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Optimizing Shiny apps</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 1: The CRAN whales app</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./simple-whale.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Simple whale</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="header-section-number">3</span> Intro</a></li>
  <li>
<a href="#a-tour-by-cran-whales" id="toc-a-tour-by-cran-whales" class="nav-link" data-scroll-target="#a-tour-by-cran-whales"><span class="header-section-number">4</span> A tour by CRAN whales</a>
  <ul class="collapse">
<li><a href="#widgets" id="toc-widgets" class="nav-link" data-scroll-target="#widgets"><span class="header-section-number">4.1</span> Widgets</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><span class="header-section-number">4.2</span> The data</a></li>
  <li><a href="#tab-1-all-traffic" id="toc-tab-1-all-traffic" class="nav-link" data-scroll-target="#tab-1-all-traffic"><span class="header-section-number">4.3</span> Tab 1: All traffic</a></li>
  <li><a href="#tab-2-biggest-whales" id="toc-tab-2-biggest-whales" class="nav-link" data-scroll-target="#tab-2-biggest-whales"><span class="header-section-number">4.4</span> Tab 2: Biggest whales</a></li>
  <li><a href="#tab-3-whales-by-hour" id="toc-tab-3-whales-by-hour" class="nav-link" data-scroll-target="#tab-3-whales-by-hour"><span class="header-section-number">4.5</span> Tab 3: Whales by hour</a></li>
  <li><a href="#tab-4-detail-view" id="toc-tab-4-detail-view" class="nav-link" data-scroll-target="#tab-4-detail-view"><span class="header-section-number">4.6</span> Tab 4: Detail view</a></li>
  </ul>
</li>
  <li>
<a href="#app-1-modern-cranwhales" id="toc-app-1-modern-cranwhales" class="nav-link" data-scroll-target="#app-1-modern-cranwhales"><span class="header-section-number">5</span> App 1: modern cranwhales</a>
  <ul class="collapse">
<li>
<a href="#code" id="toc-code" class="nav-link" data-scroll-target="#code"><span class="header-section-number">5.1</span> Code</a>
  <ul class="collapse">
<li><a href="#ui" id="toc-ui" class="nav-link" data-scroll-target="#ui"><span class="header-section-number">5.1.1</span> UI</a></li>
  <li><a href="#server" id="toc-server" class="nav-link" data-scroll-target="#server"><span class="header-section-number">5.1.2</span> Server</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">5.1.3</span> Data</a></li>
  <li><a href="#plots" id="toc-plots" class="nav-link" data-scroll-target="#plots"><span class="header-section-number">5.1.4</span> Plots</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#intermezzo-profiling-app-1" id="toc-intermezzo-profiling-app-1" class="nav-link" data-scroll-target="#intermezzo-profiling-app-1"><span class="header-section-number">6</span> Intermezzo: profiling App 1</a>
  <ul class="collapse">
<li><a href="#profviz" id="toc-profviz" class="nav-link" data-scroll-target="#profviz"><span class="header-section-number">6.1</span> <code>profviz</code></a></li>
  <li><a href="#shinyloadtest" id="toc-shinyloadtest" class="nav-link" data-scroll-target="#shinyloadtest"><span class="header-section-number">6.2</span> <code>shinyloadtest</code></a></li>
  </ul>
</li>
  <li>
<a href="#app-2-avoid-redundances-and-cache-what-you-can" id="toc-app-2-avoid-redundances-and-cache-what-you-can" class="nav-link" data-scroll-target="#app-2-avoid-redundances-and-cache-what-you-can"><span class="header-section-number">7</span> App 2: avoid redundances and cache what you can</a>
  <ul class="collapse">
<li><a href="#some-key-points-when-using-bindcache" id="toc-some-key-points-when-using-bindcache" class="nav-link" data-scroll-target="#some-key-points-when-using-bindcache"><span class="header-section-number">7.0.1</span> Some key points when using <code>bindCache</code></a></li>
  <li><a href="#app-3-going-async" id="toc-app-3-going-async" class="nav-link" data-scroll-target="#app-3-going-async"><span class="header-section-number">7.0.2</span> App 3: going async</a></li>
  <li><a href="#app-4-exposing-the-backend" id="toc-app-4-exposing-the-backend" class="nav-link" data-scroll-target="#app-4-exposing-the-backend"><span class="header-section-number">7.0.3</span> App 4: exposing the backend</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./simple-whale.html">Part 1: The CRAN whales app</a></li><li class="breadcrumb-item"><a href="./simple-whale.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Simple whale</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Simple whale</span>
</h1>
<p class="subtitle lead">A guide to serve a shiny app to the maximum amount of people ever imagined</p>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header><section id="intro" class="level1" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> Intro</h1>
<blockquote class="blockquote">
<p>Given a fixed amount of hardware serving the shiny app (say, 2 cores) and a fixed amount of hardware serving an optional API backend (say, 4 cores), how many people can access a shiny app and have a good experience? Can we make it to a thousand?</p>
</blockquote>
<p>This guide is a modern reading of the classic <code>promises</code> <a href="https://rstudio.github.io/promises/articles/promises_08_casestudy.html">Case study: converting a Shiny app to async</a> mixed with <code>shinyloadtest</code> <a href="https://rstudio.github.io/shinyloadtest/articles/case-study-scaling.html">Case study: Scaling an app</a>.</p>
<p>Starting with an innocent shiny app, we will do many steps to make it more performant and analyze how many people can use it at the same time, <a href="https://rstudio.github.io/shinyloadtest/articles/analyzing-load-test-logs.html">creating reports</a> with <code>shinyloadtest</code> and <code>shinycannon</code>. The roadmap is the following:</p>
<ul>
<li>App 1: the first version of the <a href="https://rstudio.github.io/promises/articles/promises_08_casestudy.html">cranwhales app</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. We will modify some things to make it more modern (for example, use <code>bslib</code>).</li>
<li>App 2: modify App 1 to introduce cache and memoise; use faster functions where possible.</li>
<li>App 3: modify App 2 to introduce async via the <a href="https://rstudio.github.io/shiny/reference/ExtendedTask.html">new ExtendedTask</a>.</li>
<li>App 4-R: modify App 3 to use an external <a href="https://www.rplumber.io/">plumber API</a>.</li>
<li>App 4-Julia: modify App 3 to use an external API made in <a href="https://julialang.org/">Julia</a> with <a href="https://oxygenframework.github.io/Oxygen.jl/stable/">Oxygen.jl</a>. Julia is known for being a high-performance language, so let’s give it a try here.</li>
<li>App 4-Python: modify App 3 to use an external API made in fastapi?</li>
</ul>
<p>The repo is structured as a R package to make it easy to track dependencies, load functions and share them between the apps.</p>
</section><section id="a-tour-by-cran-whales" class="level1" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> A tour by CRAN whales</h1>
<p>You can see it <a href="https://gallery.shinyapps.io/cranwhales/">online</a> or follow me in this guided tour.</p>
<p>The app intention is to show the <em>whales</em>: certain IPs that download <em>a lot</em> of data from CRAN. Let me describe its features.</p>
<section id="widgets" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="widgets">
<span class="header-section-number">4.1</span> Widgets</h2>
<p>The app has two widgets in a sidebar: - a date selector, stored in <code>input$date</code>: the day of the downloads. - a numeric input with the amount of <em>whales</em> (that is: the top N downloaders); stored in <code>input$n_whales</code>. It goes from 1 to 25.</p>
<p>There is no button.</p>
<p><img src="images/app-filter.png" class="img-fluid"></p>
</section><section id="the-data" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="the-data">
<span class="header-section-number">4.2</span> The data</h2>
<p>For each selected date, the app should download the zipped file from <a href="http://cran-logs.rstudio.com/">http://cran-logs.rstudio.com/</a> and read it.</p>
<p>We will store the downloaded data to be read again for the next user, but will delete all data when the app starts globally (not per-user) mimicking the fresh start of a new server.</p>
<p>Each zipped file has around ~90MB and stores a dataframe with ~7 million rows and 6 columns; it takes ~250MB of RAM after read. Here is a glimpse of the dataset:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># df = download_and_read()</span></span>
<span><span class="co"># glimpse(df, n = 10)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="tab-1-all-traffic" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="tab-1-all-traffic">
<span class="header-section-number">4.3</span> Tab 1: All traffic</h2>
<p>This tab show three value boxes and a chart with the amount of downloads per hour, colored by whales vs.&nbsp;non-whales. You can see the impact of 6 users compared to the total ~58k users.</p>
<p><img src="images/app-all_traffic.png" class="img-fluid"></p>
<p>We need to calculate the top N whales<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and store it in a variable; then we calculate the amount of downloads per id per hour and colour by whale vs.&nbsp;non-whale.</p>
</section><section id="tab-2-biggest-whales" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="tab-2-biggest-whales">
<span class="header-section-number">4.4</span> Tab 2: Biggest whales</h2>
<p>Here we compare the amount of downloads between the whales in a single day.</p>
<p><img src="images/app-biggest-whales.png" class="img-fluid"></p>
</section><section id="tab-3-whales-by-hour" class="level2" data-number="4.5"><h2 data-number="4.5" class="anchored" data-anchor-id="tab-3-whales-by-hour">
<span class="header-section-number">4.5</span> Tab 3: Whales by hour</h2>
<p>For each whale in a facet, count the downloads by hour.</p>
<p><img src="images/app-whales-by-hour.png" class="img-fluid"></p>
</section><section id="tab-4-detail-view" class="level2" data-number="4.6"><h2 data-number="4.6" class="anchored" data-anchor-id="tab-4-detail-view">
<span class="header-section-number">4.6</span> Tab 4: Detail view</h2>
<p>In the detail view, we can see which package was downloaded in a timeline by selecting a whale.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/app-detail-view1.png" class="img-fluid figure-img"></p>
<figcaption>A whale that downloaded many packages all the time</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/app-detail-view2.png" class="img-fluid figure-img"></p>
<figcaption>A whale that downloaded one package at a time, in a organized manner</figcaption></figure>
</div>
</section></section><section id="app-1-modern-cranwhales" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> App 1: modern cranwhales</h1>
<p>I’ve made some changes compared to the original 2018 CRAN whales app:</p>
<ul>
<li><p>I used the more modern <code>bslib</code> instead of <code>shinydashboard</code>.</p></li>
<li><p>I created a module for each page and appended the app version to it (for example, <code>md1.all_traffic_UI</code> means “module for app 1”). I also prepared all possible data in server before passing these to the modules<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. It will be easier to optimize the app later in this setting, and I pass to each module just the essential.</p></li>
<li><p>I isolated all calculations and plots in separate files (<code>R/data.R</code> and <code>R/plots</code>), to be reused. More important: inside a <code>renderPlot</code> there is no calculation; in this way, a typical pipeline is <code>raw_data |&gt; prepare_data() |&gt; plot_data()</code>.</p></li>
</ul>
<p>To run the app, load all dependencies with <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> (or control+shift+L, in RStudio) and just run</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">run_app1</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/app1-t1.png" class="img-fluid"></p>
<p><img src="images/app1-t2.png" class="img-fluid"></p>
<p><img src="images/app1-t3.png" class="img-fluid"></p>
<p><img src="images/app1-t4.png" class="img-fluid"></p>
<section id="code" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="code">
<span class="header-section-number">5.1</span> Code</h2>
<p>Here I show a bit of code; this session can be skipped, but some details about the server will be needed later.</p>
<section id="ui" class="level3" data-number="5.1.1"><h3 data-number="5.1.1" class="anchored" data-anchor-id="ui">
<span class="header-section-number">5.1.1</span> UI</h3>
<p>The UI simply call the modules</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ui1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">page_navbar</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"CRAM whales 2.0"</span>,</span>
<span>    theme <span class="op">=</span> <span class="fu">my_bs_theme</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    sidebar <span class="op">=</span> <span class="fu">sidebar</span><span class="op">(</span></span>
<span>      <span class="fu">dateInput</span><span class="op">(</span>inputId <span class="op">=</span> <span class="st">"date"</span>, label <span class="op">=</span> <span class="st">"Date"</span>, value <span class="op">=</span> <span class="fu">app_start_date</span><span class="op">(</span><span class="op">)</span>, max <span class="op">=</span> <span class="fu">app_start_date</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu">numericInput</span><span class="op">(</span>inputId <span class="op">=</span> <span class="st">"n_whales"</span>, label <span class="op">=</span> <span class="st">"Show top N downloaders:"</span>, <span class="fl">6</span>, min <span class="op">=</span> <span class="fl">1</span>, max <span class="op">=</span> <span class="fl">25</span>, step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu">nav_panel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"All traffic"</span>, <span class="fu">md1.all_traffic_UI</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">nav_panel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Biggest whales"</span>, <span class="fu">md1.biggest_whales_UI</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">nav_panel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Whales by hour"</span>, <span class="fu">md1.whales_by_hour_UI</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">nav_panel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Detail view"</span>, <span class="fu">md1.detail_view_UI</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">ui</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="server" class="level3" data-number="5.1.2"><h3 data-number="5.1.2" class="anchored" data-anchor-id="server">
<span class="header-section-number">5.1.2</span> Server</h3>
<p>In the server I tried to calculate all necessary reactives to pass to modules; reactives have a <code>rc.</code> to be easy to remember which objects are reactive and which are not.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">server1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># rc.data: read data ------------------------------------------------------</span></span>
<span>  <span class="va">rc.data</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">download_and_read</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Tab 1: All traffic ------------------------------------------------------</span></span>
<span>  <span class="co"># rc.count: simple counting -----------------------------------------------</span></span>
<span>  <span class="va">rc.count</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_count_downloads</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># rc.whales: separate the whales ------------------------------------------</span></span>
<span>  <span class="va">rc.whales</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">create_ip_names</span><span class="op">(</span><span class="fu">rc.count</span><span class="op">(</span><span class="op">)</span>, <span class="va">input</span><span class="op">$</span><span class="va">n_whales</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n_whales</span>, <span class="fu">rc.count</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rc.whales_vs_non_whales_by_hour</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_whales_vs_non_whales_by_hour</span><span class="op">(</span>df <span class="op">=</span> <span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span>, whale_ip <span class="op">=</span> <span class="fu">rc.whales</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">ip_id</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># rc.valueboxes ------------------------------------------------------------</span></span>
<span>  <span class="va">rc.valuebox1</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_valuebox_size</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rc.valuebox2</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_valuebox_rows</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rc.valuebox3</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_valuebox_unique_ids</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Tab 2: Biggest whales ---------------------------------------------------</span></span>
<span>  <span class="co"># reuse rc.whales</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Tab 3: Whales by hour ---------------------------------------------------</span></span>
<span>  <span class="co"># rc.downloads_by_hour_with_names -----------------------------------------</span></span>
<span>  <span class="va">rc.downloads_by_hour_with_names</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_whales_by_hour</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span>, <span class="fu">rc.whales</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Tab 4: Detail view ------------------------------------------------------</span></span>
<span>  <span class="co"># uses rc.data and rc.whales</span></span>
<span></span>
<span>  <span class="co"># modules -----------------------------------------------------------------</span></span>
<span>  <span class="fu">md1.all_traffic_server</span><span class="op">(</span></span>
<span>    rc.valuebox1 <span class="op">=</span> <span class="va">rc.valuebox1</span>, rc.valuebox2 <span class="op">=</span> <span class="va">rc.valuebox2</span>, rc.valuebox3 <span class="op">=</span> <span class="va">rc.valuebox3</span>,</span>
<span>    rc.whales_vs_non_whales_by_hour <span class="op">=</span> <span class="va">rc.whales_vs_non_whales_by_hour</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">md1.biggest_whales_server</span><span class="op">(</span>rc.biggest_whales <span class="op">=</span> <span class="va">rc.whales</span><span class="op">)</span></span>
<span>  <span class="fu">md1.whales_by_hour_server</span><span class="op">(</span>rc.downloads_by_hour_with_names <span class="op">=</span> <span class="va">rc.downloads_by_hour_with_names</span><span class="op">)</span></span>
<span>  <span class="fu">md1.detail_view_server</span><span class="op">(</span>rc.data <span class="op">=</span> <span class="va">rc.data</span>, rc.whales <span class="op">=</span> <span class="va">rc.whales</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="data" class="level3" data-number="5.1.3"><h3 data-number="5.1.3" class="anchored" data-anchor-id="data">
<span class="header-section-number">5.1.3</span> Data</h3>
<p>The <code>r/data.R</code> file has all the functions necessary to read files and do the calculations.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># read data ---------------------------------------------------------------</span></span>
<span><span class="va">create_dir_and_delete_files</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"data_cache"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"data_cache"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">file_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data_cache"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">".csv.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">path</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">download_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">date</span> <span class="op">=</span> <span class="fu">today</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fu">days</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">year</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"http://cran-logs.rstudio.com/{year}/{date}.csv.gz"</span><span class="op">)</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">file_path</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># download only if file does not exist</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">url</span>, destfile <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span>
<span></span>
<span>  <span class="cn">NULL</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">read_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">date</span> <span class="op">=</span> <span class="fu">today</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fu">days</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">file_path</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="va">path</span>, col_types <span class="op">=</span> <span class="st">"Dti---f-fi"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">package</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>hour <span class="op">=</span> <span class="fu">hms</span><span class="fu">::</span><span class="fu"><a href="https://hms.tidyverse.org/reference/round_hms.html">trunc_hms</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">60</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">download_and_read</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">date</span> <span class="op">=</span> <span class="fu">today</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fu">days</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">download_data</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="fu">read_data</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 1: all traffic -----------------------------------------------------------</span></span>
<span><span class="va">calc_valuebox_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">size</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">gdata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gdata/man/humanReadable.html">humanReadable</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">calc_valuebox_rows</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">format_number</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">calc_valuebox_unique_ids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">ip_id</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">format_number</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">calc_count_downloads</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">ip_id</span>, <span class="va">country</span>, name <span class="op">=</span> <span class="st">"downloads"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">downloads</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">calc_whales_vs_non_whales_by_hour</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">whale_ip</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">whales_vs_non_whales_by_hour</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      is_whale <span class="op">=</span> <span class="va">ip_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">whale_ip</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">hour</span>, <span class="va">is_whale</span>, name <span class="op">=</span> <span class="st">"downloads"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">whales_vs_non_whales_by_hour</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 2: biggest whales ------------------------------------------------------------------</span></span>
<span><span class="va">create_ip_names</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_count</span>, <span class="va">n_whales</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df_count</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_whales</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ip_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"WHALE_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">2</span>, flag <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>, <span class="st">" ["</span>, <span class="va">country</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 3: whales by hour ----------------------------------------------------------</span></span>
<span><span class="va">calc_whales_by_hour</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">df_whales</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">whales_by_hour</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">df_whales</span>, by <span class="op">=</span> <span class="st">"ip_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">hour</span>, <span class="va">ip_name</span>, name <span class="op">=</span> <span class="st">"downloads"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">whales_by_hour</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># tab 4: detail view ----------------------------------------------------------</span></span>
<span><span class="va">calc_valuebox_unique_packages</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">package</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">format_number</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="plots" class="level3" data-number="5.1.4"><h3 data-number="5.1.4" class="anchored" data-anchor-id="plots">
<span class="header-section-number">5.1.4</span> Plots</h3>
<p>Here we stored every function related to plotting things. They were stolen as-is from the original <a href="https://github.com/rstudio/cranwhales/blob/sync/app.R">CRAN whales app code</a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">my_gg_theme</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 1: all traffic -------------------------------------------------------------</span></span>
<span><span class="va">plot_whales_vs_non_whales_by_hour</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">whales_vs_non_whales_by_hour</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">whales_vs_non_whales_by_hour</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">hour</span>, <span class="va">downloads</span>, fill <span class="op">=</span> <span class="va">is_whale</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#666666"</span>, <span class="st">"#88FF99"</span><span class="op">)</span>,</span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"no"</span>, <span class="st">"yes"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Downloads"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Hour"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/comma.html">comma</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">my_gg_theme</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 2: biggest whales ------------------------------------------------------------------</span></span>
<span><span class="va">plot_biggest_whales</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">biggest_whales</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">biggest_whales</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">ip_name</span>, <span class="va">downloads</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Downloads on this day"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">my_gg_theme</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 3: whales by hour ----------------------------------------------------------</span></span>
<span><span class="va">plot_downloads_by_hour_whales</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">downloads_by_hour_with_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">downloads_by_hour_with_names</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">hour</span>, <span class="va">downloads</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">ip_name</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Downloads"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Hour"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">my_gg_theme</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># tab 4: detail view ----------------------------------------------------------</span></span>
<span><span class="va">plot_whale_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">whale_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">whale_data</span><span class="op">$</span><span class="va">package</span><span class="op">)</span></span>
<span>  <span class="va">breaks</span> <span class="op">&lt;-</span> <span class="va">pkg</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">1</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">whale_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">time</span>, <span class="va">package</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_x_time</span><span class="op">(</span></span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu">hms</span><span class="fu">::</span><span class="fu"><a href="https://hms.tidyverse.org/reference/hms.html">hms</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">60</span> <span class="op">*</span> <span class="fl">60</span> <span class="op">*</span> <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>,</span>
<span>      limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">hms</span><span class="fu">::</span><span class="fu"><a href="https://hms.tidyverse.org/reference/hms.html">hms</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu">hms</span><span class="fu">::</span><span class="fu"><a href="https://hms.tidyverse.org/reference/hms.html">hms</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">24</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_y_discrete</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section></section><section id="intermezzo-profiling-app-1" class="level1" data-number="6"><h1 data-number="6">
<span class="header-section-number">6</span> Intermezzo: profiling App 1</h1>
<p>There are two ways to measure the performance of this app:</p>
<ul>
<li><p>We can analyze the amount of time each function takes to execute and try to optimize them. This measures the experience of a single user. We will use ’profviz` for that.</p></li>
<li><p>We can analyze the behavior of <span class="math inline">\(n\)</span> concurrent users in the app and see what functions/outputs/reactives are taking more time. Remember: since R is single-threaded, if 10 people are using the app and one session triggers a slow calculation, all sessions will have to wait for it to finish. We will use <code>shinyloadtest</code> for that.</p></li>
</ul>
<section id="profviz" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="profviz">
<span class="header-section-number">6.1</span> <code>profviz</code>
</h2>
<p>Following <a href="https://profvis.r-lib.org/articles/examples.html#example-3---profiling-a-shiny-application">this tutorial</a> from the <code>profviz</code> package, I recorded one session of the app being used. I just roamed around a bit, changing the inputs and seeing some graphs.</p>
<p>Looking at the profviz result, we can think of some changes to make in the app:</p>
<ul>
<li>The function <code>calc_whales_by_hour</code> takes around 1/4 seconds to run; it is not bad, but with dozens of concurrent users this can be a problem.</li>
</ul>
<p>The code for this function is simple:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">calc_whales_by_hour</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">df_whales</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">whales_by_hour</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">df_whales</span>, by <span class="op">=</span> <span class="st">"ip_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">hour</span>, <span class="va">ip_name</span>, name <span class="op">=</span> <span class="st">"downloads"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">whales_by_hour</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but with 7 million rows this anti join can get a little slow. Every time you change the number of whales, this is recalculated. One solution is to calculate the counting just one time for every ip_id and already calculate the top 25 whales (which is the maximum number for the selectInput).</p>
<ul>
<li>Downloading the data takes a long time. Some files can have ~100MB. Reading them also takes time. We will cache these operations.</li>
</ul></section><section id="shinyloadtest" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="shinyloadtest">
<span class="header-section-number">6.2</span> <code>shinyloadtest</code>
</h2>
<p>Following the <a href="https://rstudio.github.io/shinyloadtest/index.html"><code>shinyloadtest</code> docs</a>, we have to:</p>
<ul>
<li><p><a href="https://rstudio.github.io/shinyloadtest/articles/shinycannon.html">Install <code>shinycannon</code></a>: a tool in Java to simulate <span class="math inline">\(n\)</span> concurrent users. If you got any errors, take a look at your Java version.</p></li>
<li><p>Run your app in a background job (to not block your R session).</p></li>
</ul>
<p>I created a directory called <code>jobs/</code> where I stored these scripts. For example, to run App 1 deleting all the files in <code>data_cache</code>, I wrote</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">run_app1</span><span class="op">(</span>delete_files <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and then click to run as background job on RStudio.</p>
<ul>
<li>Run <code>record_session</code>: this will open a new tab where you can play around the app simulating a user; the output is a <em>recording</em> object.</li>
</ul>
<p>More precisely, I ran</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">shinyloadtest</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/shinyloadtest/reference/record_session.html">record_session</a></span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"http://127.0.0.1:8001"</span><span class="op">)</span>, output_file <span class="op">=</span> <span class="st">"app1"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Use the <code>shinycannon</code> command to run the recording with <span class="math inline">\(n\)</span> users. Here I chose <span class="math inline">\(n = 10\)</span> and a minimum duration of 4 minutes. The output is saved on <code>run_app1w10</code> (App 1, run with 10 workers).</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>shinycannon app1 http:/<span class="at">/127</span>.0.0.1:8001 -<span class="at">-workers</span> 10 -<span class="at">-loaded-duration-minutes</span> 4 -<span class="at">-output-dir</span> run_app1w10 -<span class="at">-overwrite-output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can see <code>R/load_test.R</code> for some auxiliary functions.</p>
<p>The complete report can be seen on <code>my_runs.html</code>, but here are some highlights:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/run_app1w10-1.png" class="img-fluid figure-img"></p>
<figcaption>The time spent by each user session. In an app with no delays, all sessions should finish at a close time.</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/run_app1w10-2.png" class="img-fluid figure-img"></p>
<figcaption>A detailed view of the time to load the home page per session. Notice that some users had to wait more than 30 seconds to load the home page.</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/run_app1w10-3.png" class="img-fluid figure-img"></p>
<figcaption>Boxplot of time spent on each task.</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/run_app1w10-4.png" class="img-fluid figure-img"></p>
<figcaption>There is even an interesting plot which correlates the amount of time spent by a process with the amount of concurrent users. We can see that the load page time increases with the amount of users.</figcaption></figure>
</div>
</section></section><section id="app-2-avoid-redundances-and-cache-what-you-can" class="level1" data-number="7"><h1 data-number="7">
<span class="header-section-number">7</span> App 2: avoid redundances and cache what you can</h1>
<p>We modified the server of App 1 as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#| code-fold: true</span></span>
<span></span>
<span><span class="va">server2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># rc.data: read data ------------------------------------------------------</span></span>
<span>  <span class="va">rc.data</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">download_and_read</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindCache</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Tab 1: All traffic ------------------------------------------------------</span></span>
<span>  <span class="co"># rc.count: simple counting -----------------------------------------------</span></span>
<span>  <span class="va">rc.count</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_count_downloads</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindCache</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># rc.whales: separate the whales ------------------------------------------</span></span>
<span>  <span class="va">rc.whales</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">create_ip_names</span><span class="op">(</span><span class="fu">rc.count</span><span class="op">(</span><span class="op">)</span>, <span class="va">input</span><span class="op">$</span><span class="va">n_whales</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindCache</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="va">input</span><span class="op">$</span><span class="va">n_whales</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rc.whales_vs_non_whales_by_hour</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_whales_vs_non_whales_by_hour</span><span class="op">(</span>df <span class="op">=</span> <span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span>, whale_ip <span class="op">=</span> <span class="fu">rc.whales</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">ip_id</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindCache</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="va">input</span><span class="op">$</span><span class="va">n_whales</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># rc.valueboxes ------------------------------------------------------------</span></span>
<span>  <span class="va">rc.valuebox1</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_valuebox_size</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rc.valuebox2</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_valuebox_rows</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rc.valuebox3</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_valuebox_unique_ids</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Tab 2: Biggest whales ---------------------------------------------------</span></span>
<span>  <span class="co"># reuse rc.whales</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Tab 3: Whales by hour ---------------------------------------------------</span></span>
<span>  <span class="co"># rc.downloads_by_hour_with_names -----------------------------------------</span></span>
<span>  <span class="va">rc.downloads_by_hour_with_names</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">calc_whales_by_hour</span><span class="op">(</span><span class="fu">rc.data</span><span class="op">(</span><span class="op">)</span>, <span class="fu">rc.whales</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">bindCache</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">date</span>, <span class="va">input</span><span class="op">$</span><span class="va">n_whales</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Tab 4: Detail view ------------------------------------------------------</span></span>
<span>  <span class="co"># uses rc.data and rc.whales</span></span>
<span></span>
<span>  <span class="co"># modules -----------------------------------------------------------------</span></span>
<span>  <span class="fu">md1.all_traffic_server</span><span class="op">(</span></span>
<span>    rc.valuebox1 <span class="op">=</span> <span class="va">rc.valuebox1</span>, rc.valuebox2 <span class="op">=</span> <span class="va">rc.valuebox2</span>, rc.valuebox3 <span class="op">=</span> <span class="va">rc.valuebox3</span>,</span>
<span>    rc.whales_vs_non_whales_by_hour <span class="op">=</span> <span class="va">rc.whales_vs_non_whales_by_hour</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">md1.biggest_whales_server</span><span class="op">(</span>rc.biggest_whales <span class="op">=</span> <span class="va">rc.whales</span><span class="op">)</span></span>
<span>  <span class="fu">md1.whales_by_hour_server</span><span class="op">(</span>rc.downloads_by_hour_with_names <span class="op">=</span> <span class="va">rc.downloads_by_hour_with_names</span><span class="op">)</span></span>
<span>  <span class="fu">md2.detail_view_server</span><span class="op">(</span>rc.data <span class="op">=</span> <span class="va">rc.data</span>, rc.whales <span class="op">=</span> <span class="va">rc.whales</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- Check if I need add cache in the other mods -->
<p>We also cached the plots, for example in the last module:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="sc">!!!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We run <code>run_app2()</code> and see that only the first running of a given function is really calculated; the rest is cached.</p>
<section id="some-key-points-when-using-bindcache" class="level3" data-number="7.0.1"><h3 data-number="7.0.1" class="anchored" data-anchor-id="some-key-points-when-using-bindcache">
<span class="header-section-number">7.0.1</span> Some key points when using <code>bindCache</code>
</h3>
<ul>
<li>The cache key can’t be too big. Using the entire <code>rc.data()</code> would be slow. Since there is a bijection between days and rc.data, we can use solely the date.</li>
</ul>
<div class="callout callout-style-simple callout-note callout-titled" title="`bindCache` docs">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>bindCache</code> docs
</div>
</div>
<div class="callout-body-container callout-body">
<p>To compute the cache key, bindCache() hashes the contents of …, so it’s best to avoid including large objects in a cache key since that can result in slow hashing. It’s also best to avoid reference objects like environments and R6 objects, since the serialization of these objects may not capture relevant changes.</p>
<p>If you want to use a large object as part of a cache key, it may make sense to do some sort of reduction on the data that still captures information about whether a value can be retrieved from the cache. For example, if you have a large data set with timestamps, it might make sense to extract the most recent timestamp and return that. Then, instead of hashing the entire data object, the cached reactive only needs to hash the timestamp.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">reactive</span>({ <span class="fu">compute</span>(<span class="fu">bigdata</span>()) } <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bindCache</span>({ <span class="fu">extract_most_recent_time</span>(<span class="fu">bigdata</span>()) })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li><p>Saving a big object in the disk takes time! The first time we read a file, a copy of <code>rc.data</code> is going to be saved as a RDS file in the <code>myapp-cache</code> dir. This can take some seconds to finish.</p></li>
<li><p>We are using <code>shinyOptions(cache = cachem::cache_disk("./myapp-cache", max_size = 1024 * 1024^2, logfile = stdout(), evict = "lru"))</code> as the caching options. This means that the cache will be saved on disk so all users (even in different sessions) can access the cache. The files will be saved up to 1GB and then the least used will be deleted.</p></li>
</ul></section><section id="app-3-going-async" class="level3" data-number="7.0.2"><h3 data-number="7.0.2" class="anchored" data-anchor-id="app-3-going-async">
<span class="header-section-number">7.0.2</span> App 3: going async</h3>
</section><section id="app-4-exposing-the-backend" class="level3" data-number="7.0.3"><h3 data-number="7.0.3" class="anchored" data-anchor-id="app-4-exposing-the-backend">
<span class="header-section-number">7.0.3</span> App 4: exposing the backend</h3>


</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>see online version <a href="https://gallery.shinyapps.io/cranwhales/">here</a> or code <a href="https://github.com/rstudio/cranwhales">here</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>N = <code>input$n_whales</code><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>only the last tab has widgets, so the other modules just receive a reactive and plot something.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation column-body"><div class="nav-page nav-page-previous">
      <a href="./intro.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./summary.html" class="pagination-link" aria-label="Summary">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Summary</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Text here</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>